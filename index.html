<html>

<div id="main">
	
	<body id="index" onload="">
		
	
	
	<label for="search">Search</label><input type="text" name="search" value="" id="search">
	<button id="searchButton">Search</button>
	
	<button id="stopButton">Stop</button>
	
	<div id="searchResults">
		<ul>
			
		</ul>
	</div>
	
	<h1 id="a"></h1>
	
	</body>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" charset="utf-8" src="shared.js"></script>
<script type="text/javascript" charset="utf-8" src="functions.js"></script>
<script type="text/javascript" charset="utf-8" src="events.js"></script>

<script type="text/javascript" charset="utf-8">


window.onload = init;
var context;
var bufferLoader;
var startingSource = null;
var bpmIntverval = null;

var currentTrack = {
	startingTime: 0,
	data: null,
	artistId: ""
};

$("#stopButton").click(function(){
	// startingSource.stop();
	startingSource.playbackRate.value = 0;
	console.log(startingSource);
	clearInterval(bpmIntverval);
});

// var currentTrackSta
// var currentTrackData = null;

function loadInTrackData(data) {
	console.log("done callback");
	currentTrack.data = data;
}

function init() {
  context = new webkitAudioContext();

}

function finishedLoadingStart(buffer) {
	startingSource = context.createBufferSource();
	startingSource.buffer = buffer;
    startingSource.connect(context.destination);
    startingSource.start(0);
	startingSource.playbackRate = 1;
	currentTrack.startingTime = context.currentTime;
	console.log(context.currentTime);
	console.log(startingSource);
	
	bpmIntverval = setInterval(function () {
		if(!currentTrack.data || startingSource.playbackRate === 0) return;
		
		var trackTime = context.currentTime-currentTrack.startingTime;
		
		$("body").css("background-color", "#000");
		currentTrack.data.beats.forEach(function(e) {
			if(Math.abs(trackTime - e.start) < 0.1) {
				$("body").css("background-color", "#fff");
			}
			
			// console.log(trackTime +" "+ e.start);
		});
	}, 20);
	
	// console.log("started song");
}

function finishedLoading(bufferList) {
  // Create two sources and play them both together.
  source1 = context.createBufferSource();
  // var source2 = context.createBufferSource();
  source1.buffer = bufferList[0];
  // source2.buffer = bufferList[1];

  source1.connect(context.destination);
  // source2.connect(context.destination);
  source1.start(0);
  // source2.start(0);
  
  // setInterval(function() {
  // 	  console.log(context.currentTime);
  // }, 200);
  
 
}


$("#searchButton").click(function() {
	console.log("searching " + $("#search").val());

	$.get("https://api.spotify.com/v1/search", {
		q: $("#search").val(),
		type: "track,artist"
	}).done(function(data) {
		console.log(data.tracks);
		var items = data.tracks.items;
		$("#searchResults ul").html("");
		for (var i = 0; i < items.length; i++) {
			var artist = items[i].artists[0].name;
			var artistId = items[i].artists[0].id;
			var track = items[i].name;
			// console.log(item[i]);
			$("#searchResults ul").append("<li class='searchResultItem' id='"+items[i].id+"' preview='"+items[i].preview_url+"'>" + artist + ": " + track + "</li>");
		}
		
		$(".searchResultItem").click(function() {
			console.log($(this).attr("preview"));
			
			$(this).attr("preview")
			
			getPreviewData($(this).attr("preview"), loadInTrackData);
			
			if(startingSource) startingSource.stop();
			
		    bufferLoader = new BufferLoader(
		      context,
		      [],
		      finishedLoadingStart
		      );

		    bufferLoader.load( $(this).attr("preview"));
			
		});
		
	});
	
});


// $.post( "http://developer.echonest.com/api/v4/track/upload", { 
// 	api_key: "USFCOFHXTDXYNVRQ9", 
// 	url: "http://p.scdn.co/mp3-preview/ee420207228b4a0a5d44eaf4f85726b2feb614e0" 
// }).done(function( data ) {
// 
// 	var id = data.response.track.id;
// 
// 	$.get("http://developer.echonest.com/api/v4/track/profile", {
// 		api_key: "USFCOFHXTDXYNVRQ9",
// 		format: "json",
// 		id: id,
// 		bucket: "audio_summary"
// 	}).done(function(data) {
// 	
// 		var analysis_url = data.response.track.audio_summary.analysis_url;
// 		console.log(analysis_url);
// 	
// 		$.get(analysis_url).done(function(data) {
// 			// callback(data);
// 			console.log(data);
// 			console.log(JSON.stringify(data));
// 		});
// 	
// 	});	
// });

// 


// var data = {"response": {"status": {"version": "4.2", "code": 0, "message": "Success"}, "track": {"status": "pending", "song_id": "SOMONWI13D1180A591", "audio_md5": "20262c7fa2086e2505f7793e7c5c9baf", "artist": "Nick Nikolov", "title": "Come Down", "analyzer_version": "3.2.2", "release": "Berlin Afterhour 4 (From Minimal to Techno / From Electro to House)", "artist_id": "ARNBEBA1269FCD177E", "bitrate": 96, "id": "TRUQBEB14A44C7FDED", "samplerate": 44100, "md5": "20262c7fa2086e2505f7793e7c5c9baf"}}};
// 
// var id = data.response.track.id;
// console.log(id);

// var xmlhttp =  new XMLHttpRequest();
// xmlhttp.open("POST","http://developer.echonest.com/api/v4/track/upload",false);
// xmlhttp.setRequestHeader('Access-Control-Allow-Origin', '"http://developer.echonest.com');
// xmlhttp.send("api_key=USFCOFHXTDXYNVRQ9&url=http://p.scdn.co/mp3-preview/ee420207228b4a0a5d44eaf4f85726b2feb614e0.mp3");
// document.getElementById("main").innerHTML=xmlhttp.responseText;

</script>

</html>